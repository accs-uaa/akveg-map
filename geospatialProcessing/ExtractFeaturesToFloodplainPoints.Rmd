---
title: "Extract Features to Floodplain Points"
author: "Timm Nawrocki"
date: "April 19, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r header}
# -*- coding: utf-8 -*-
# ---------------------------------------------------------------------------
# Extract Features to Floodplain Points
# Author: Timm Nawrocki, Alaska Center for Conservation Science
# Created on: 2019-04-19
# Usage: Code chunks must be executed sequentially in R Studio or R Studio Server installation. Created using R Studio version 1.2.1335 and R 3.5.3.
# Description: "Extract Features to Floodplain Points" creates a csv table of features for all points in a sample set.
# ---------------------------------------------------------------------------
```

## 1. Introduction

This script extracts features to points in a sample set. The resulting csv file represents spatial variation in tabular form for model train and test.

## 2. Import data and variables

This script must be executed on a shapefile point feature. Features must be pre-processed using the formatting scripts in this repository to share the same extent, cell size, and grid. Extraction of features requires the sp, raster, rgdal, and stringr libraries.

```{r inputs}
# Set root directory
drive = 'E:/'
root_directory = paste(drive, '/ACCS_Work/Projects/VegetationEcology/BristolBay_Vegetation/Project_GIS', sep='')
# Define input folders
sample_folder = paste(root_directory, '/Data_Input/floodplain_points', sep='')
environmental_folder = paste(root_directory, '/Data_Input/predictor_env/partial', sep='')
spectral_folder = paste(root_directory, '/Data_Input/predictor_img/mosaic_partial', sep='')
# Define output folder
output_folder = paste(root_directory, '/Data_Output/sample_floodplain', sep='')
```

```{r libraries}
# Install required libraries if they are not already installed.
Required_Packages <- c('sp', 'raster', 'rgdal', 'stringr')
New_Packages <- Required_Packages[!(Required_Packages %in% installed.packages()[,"Package"])]
if (length(New_Packages) > 0) {
  install.packages(New_Packages)
}
# Import required libraries for geospatial processing: sp, raster, rgdal, and stringr.
library(sp)
library(raster)
library(rgdal)
library(stringr)
```

```{r prepare_inputs}
# Generate a list of all watersheds in the watersheds directory
sample_list = list.files(sample_folder, pattern='shp$', full.names=TRUE)
sample_length = length(sample_list)
# Generate a stack of all predictor variables
predictors_env = list.files(environmental_folder, pattern='tif$', full.names=TRUE)
predictors_img = list.files(spectral_folder, pattern='tif$', full.names=TRUE)
predictors_all = c(predictors_env, predictors_img)
predictor_stack = stack(predictors_all)
```

## 3. Define functions

```{r functions}
# Define a function to read a watershed dataframe, extract data, and export to csv
extractPredictorData = function(sample, inStack, outTable) {
  sample_data = readOGR(dsn=sample)
  sample_data@data <- data.frame(sample_data@data, extract(inStack, sample_data))
  write.csv(sample_data@data, file=outTable)
}
```

## 4. Conduct extractions

```{r extractions}
# Extract predictor data to each sample in the samples directory
count = 1
for (sample in sample_list) {
  print(paste('Extracting predictor data to sample ', count, ' of ', sample_length, '...', sep=''))
  count = count + 1
  output_table = paste(output_folder, '/', sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(sample)), '.csv', sep='')
  extractPredictorData(sample, predictor_stack, output_table)
}
```